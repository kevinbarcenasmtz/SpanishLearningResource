---
/**
 * LeftSidebar.astro
 *
 * Main navigation sidebar with:
 * - Content Collection lesson fetching
 * - Collapsible sections (CSS Grid 0fr → 1fr animation)
 * - Keyboard navigation (↑↓←→ Home/End, / for search)
 * - Search filtering
 * - localStorage state persistence (collapsed sections, width)
 * - Resizable with drag handle
 */

import { getCollection } from 'astro:content';

interface Props {
  currentPath?: string;
}

const { currentPath = '' } = Astro.props;

// Fetch all lessons from content collection
const allLessons = await getCollection('lessons');

// Sort by order and group by section
const lessonsBySection = allLessons
  .sort((a, b) => a.data.order - b.data.order)
  .reduce(
    (acc, lesson) => {
      const section = lesson.data.section;
      if (!acc[section]) {
        acc[section] = [];
      }
      acc[section].push({
        slug: lesson.slug,
        title: lesson.data.title,
        href: `/lessons/${lesson.slug}`,
      });
      return acc;
    },
    {} as Record<string, Array<{ slug: string; title: string; href: string }>>,
  );

// Static navigation items
const staticPages = {
  home: { title: 'Home', href: '/' },
  about: { title: 'About', href: '/about' },
};

const frontMatter = [
  { title: 'Abbreviations and Symbols', href: '/front-matter/abbreviations' },
  { title: 'Guide to IPA Pronunciation', href: '/front-matter/ipa-guide' },
  { title: 'Introduction to Mexican Spanish', href: '/front-matter/introduction' },
  { title: 'How to Use This Resource', href: '/front-matter/how-to-use' },
];

const appendices = [
  { title: 'Verb Conjugation Tables', href: '/appendices/verb-tables' },
  { title: 'Spanish-English Glossary', href: '/appendices/glossary' },
  { title: 'Idioms & Expressions', href: '/appendices/idioms' },
  { title: 'Cultural Notes Compendium', href: '/appendices/cultural-notes' },
  { title: 'Grammar Reference', href: '/appendices/grammar-reference' },
];
---

<div id="left-sidebar-container" class="sidebar-container" style="width: 100%;">
  <div class="sidebar-content">
    <!-- Search Bar -->
    <div class="p-4 pb-2">
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-secondary pointer-events-none"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="text"
          id="sidebar-search"
          placeholder="Search lessons... (Press /)"
          class="search-input"
          aria-label="Search navigation"
        />
      </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav p-4 pt-2" aria-label="Main navigation">
      <!-- Static Top Links -->
      <div class="mb-4 space-y-1">
        <a
          href={staticPages.home.href}
          class:list={['nav-item', { active: currentPath === '/' }]}
          data-nav-item
        >
          {staticPages.home.title}
        </a>
        <a
          href={staticPages.about.href}
          class:list={['nav-item', { active: currentPath === '/about' }]}
          data-nav-item
        >
          {staticPages.about.title}
        </a>
      </div>

      <!-- Divider -->
      <div class="my-3 h-px bg-border"></div>

      <!-- Front Matter Section -->
      <div class="nav-section" data-section="front-matter">
        <button
          type="button"
          class="nav-section-header"
          aria-expanded="true"
          aria-controls="section-front-matter"
        >
          <span class="text-xs font-semibold text-secondary uppercase tracking-wide"
            >Front Matter</span
          >
          <span class="nav-section-icon" aria-hidden="true"></span>
        </button>
        <div class="nav-section-content expanded" id="section-front-matter">
          <div class="nav-section-items">
            {
              frontMatter.map((item) => (
                <a
                  href={item.href}
                  class:list={['nav-item', { active: currentPath === item.href }]}
                  data-nav-item
                >
                  {item.title}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Foundation Section -->
      {
        lessonsBySection.Foundation && (
          <div class="nav-section" data-section="foundation">
            <button
              type="button"
              class="nav-section-header"
              aria-expanded="true"
              aria-controls="section-foundation"
            >
              <span class="text-xs font-semibold text-secondary uppercase tracking-wide">
                Foundation
              </span>
              <span class="nav-section-icon" aria-hidden="true" />
            </button>
            <div class="nav-section-content expanded" id="section-foundation">
              <div class="nav-section-items">
                {lessonsBySection.Foundation.map((lesson) => (
                  <a
                    href={lesson.href}
                    class:list={['nav-item', { active: currentPath === lesson.href }]}
                    data-nav-item
                  >
                    {lesson.title}
                  </a>
                ))}
              </div>
            </div>
          </div>
        )
      }

      <!-- Intermediate Section -->
      {
        lessonsBySection.Intermediate && (
          <div class="nav-section" data-section="intermediate">
            <button
              type="button"
              class="nav-section-header"
              aria-expanded="true"
              aria-controls="section-intermediate"
            >
              <span class="text-xs font-semibold text-secondary uppercase tracking-wide">
                Intermediate
              </span>
              <span class="nav-section-icon" aria-hidden="true" />
            </button>
            <div class="nav-section-content expanded" id="section-intermediate">
              <div class="nav-section-items">
                {lessonsBySection.Intermediate.map((lesson) => (
                  <a
                    href={lesson.href}
                    class:list={['nav-item', { active: currentPath === lesson.href }]}
                    data-nav-item
                  >
                    {lesson.title}
                  </a>
                ))}
              </div>
            </div>
          </div>
        )
      }

      <!-- Advanced Section -->
      {
        lessonsBySection.Advanced && (
          <div class="nav-section" data-section="advanced">
            <button
              type="button"
              class="nav-section-header"
              aria-expanded="true"
              aria-controls="section-advanced"
            >
              <span class="text-xs font-semibold text-secondary uppercase tracking-wide">
                Advanced
              </span>
              <span class="nav-section-icon" aria-hidden="true" />
            </button>
            <div class="nav-section-content expanded" id="section-advanced">
              <div class="nav-section-items">
                {lessonsBySection.Advanced.map((lesson) => (
                  <a
                    href={lesson.href}
                    class:list={['nav-item', { active: currentPath === lesson.href }]}
                    data-nav-item
                  >
                    {lesson.title}
                  </a>
                ))}
              </div>
            </div>
          </div>
        )
      }

      <!-- Appendices Section -->
      <div class="nav-section" data-section="appendices">
        <button
          type="button"
          class="nav-section-header"
          aria-expanded="true"
          aria-controls="section-appendices"
        >
          <span class="text-xs font-semibold text-secondary uppercase tracking-wide"
            >Appendices</span
          >
          <span class="nav-section-icon" aria-hidden="true"></span>
        </button>
        <div class="nav-section-content expanded" id="section-appendices">
          <div class="nav-section-items">
            {
              appendices.map((item) => (
                <a
                  href={item.href}
                  class:list={['nav-item', { active: currentPath === item.href }]}
                  data-nav-item
                >
                  {item.title}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Divider -->
      <div class="my-3 h-px bg-border"></div>

      <!-- Dark Mode Toggle -->
      <button
        type="button"
        id="theme-toggle"
        class="nav-item w-full justify-start"
        aria-label="Toggle dark mode"
      >
        <svg
          id="theme-icon-sun"
          class="h-4 w-4 hidden dark:block"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          ></path>
        </svg>
        <svg
          id="theme-icon-moon"
          class="h-4 w-4 block dark:hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          ></path>
        </svg>
        <span id="theme-text-light" class="block dark:hidden">Dark Mode</span>
        <span id="theme-text-dark" class="hidden dark:block">Light Mode</span>
      </button>
    </nav>
  </div>

  <!-- Resize Handle -->
  <div
    class="resize-handle"
    role="separator"
    aria-label="Resize sidebar"
    aria-orientation="vertical"
  >
  </div>
</div>

<script>
  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', () => {
    // ============================================================================
    // Sidebar State Management
    // ============================================================================

    const STORAGE_KEYS = {
      width: 'sidebar-width',
      collapsed: 'sidebar-collapsed-sections',
    };

    // ============================================================================
    // Collapsible Sections
    // ============================================================================

    function initCollapsibleSections() {
      const sections = document.querySelectorAll('.nav-section');
      const collapsedSections = getCollapsedSections();

      sections.forEach((section) => {
        const button = section.querySelector('.nav-section-header') as HTMLButtonElement;
        const content = section.querySelector('.nav-section-content') as HTMLElement;
        const sectionId = section.getAttribute('data-section');

        if (!button || !content || !sectionId) return;

        // Restore collapsed state from localStorage
        if (collapsedSections.includes(sectionId)) {
          content.classList.remove('expanded');
          section.classList.remove('expanded');
          button.setAttribute('aria-expanded', 'false');
        } else {
          section.classList.add('expanded');
        }

        button.addEventListener('click', () => toggleSection(section, button, content, sectionId));
      });
    }

    function toggleSection(
      section: Element,
      button: HTMLButtonElement,
      content: HTMLElement,
      sectionId: string,
    ) {
      const isExpanded = content.classList.contains('expanded');

      if (isExpanded) {
        content.classList.remove('expanded');
        section.classList.remove('expanded');
        button.setAttribute('aria-expanded', 'false');
        addCollapsedSection(sectionId);
      } else {
        content.classList.add('expanded');
        section.classList.add('expanded');
        button.setAttribute('aria-expanded', 'true');
        removeCollapsedSection(sectionId);
      }
    }

    function getCollapsedSections(): string[] {
      const stored = localStorage.getItem(STORAGE_KEYS.collapsed);
      return stored ? JSON.parse(stored) : [];
    }

    function addCollapsedSection(sectionId: string) {
      const collapsed = getCollapsedSections();
      if (!collapsed.includes(sectionId)) {
        collapsed.push(sectionId);
        localStorage.setItem(STORAGE_KEYS.collapsed, JSON.stringify(collapsed));
      }
    }

    function removeCollapsedSection(sectionId: string) {
      const collapsed = getCollapsedSections().filter((id) => id !== sectionId);
      localStorage.setItem(STORAGE_KEYS.collapsed, JSON.stringify(collapsed));
    }

    // ============================================================================
    // Keyboard Navigation
    // ============================================================================

    function initKeyboardNavigation() {
      const searchInput = document.getElementById('sidebar-search') as HTMLInputElement;

      // Global "/" shortcut to focus search
      document.addEventListener('keydown', (e) => {
        // Skip if user is typing in an input
        if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
          return;
        }

        if (e.key === '/' && document.activeElement !== searchInput) {
          e.preventDefault();
          searchInput?.focus();
          return;
        }

        // Arrow key navigation
        if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(e.key)) {
          return;
        }

        e.preventDefault();

        const items = Array.from(document.querySelectorAll('[data-nav-item]')) as HTMLElement[];
        const activeElement = document.activeElement as HTMLElement;
        const isNavItem = activeElement?.hasAttribute('data-nav-item');

        let currentIndex = -1;

        if (isNavItem) {
          // Focus is on a nav item, use it
          currentIndex = items.indexOf(activeElement);
        } else {
          // Focus is elsewhere (probably body), find the .active nav item
          const activeNavItem = document.querySelector('[data-nav-item].active') as HTMLElement;
          if (activeNavItem) {
            currentIndex = items.indexOf(activeNavItem);
          } else {
            // No active item, start from first item
            currentIndex = -1;
          }
        }

        switch (e.key) {
          case 'ArrowDown':
            focusItem(items, currentIndex + 1);
            break;
          case 'ArrowUp':
            focusItem(items, currentIndex - 1);
            break;
          case 'ArrowLeft':
            if (isNavItem) {
              collapseCurrentSection(activeElement);
            }
            break;
          case 'ArrowRight':
            if (isNavItem) {
              expandCurrentSection(activeElement);
            }
            break;
          case 'Home':
            focusItem(items, 0);
            break;
          case 'End':
            focusItem(items, items.length - 1);
            break;
        }
      });
    }

    function focusItem(items: HTMLElement[], index: number) {
      if (index < 0) index = items.length - 1;
      if (index >= items.length) index = 0;
      items[index]?.focus();
    }

    function collapseCurrentSection(element: HTMLElement) {
      const section = element.closest('.nav-section');
      if (!section) return;

      const button = section.querySelector('.nav-section-header') as HTMLButtonElement;
      const content = section.querySelector('.nav-section-content') as HTMLElement;
      const sectionId = section.getAttribute('data-section');

      if (button && content && sectionId && content.classList.contains('expanded')) {
        toggleSection(section, button, content, sectionId);
      }
    }

    function expandCurrentSection(element: HTMLElement) {
      const section = element.closest('.nav-section');
      if (!section) return;

      const button = section.querySelector('.nav-section-header') as HTMLButtonElement;
      const content = section.querySelector('.nav-section-content') as HTMLElement;
      const sectionId = section.getAttribute('data-section');

      if (button && content && sectionId && !content.classList.contains('expanded')) {
        toggleSection(section, button, content, sectionId);
      }
    }

    // ============================================================================
    // Search Filtering
    // ============================================================================

    function initSearch() {
      const searchInput = document.getElementById('sidebar-search') as HTMLInputElement;
      const navItems = document.querySelectorAll('[data-nav-item]');
      const sections = document.querySelectorAll('.nav-section');
      const nav = document.querySelector('.sidebar-nav') as HTMLElement;

      if (!searchInput) return;

      // Create empty state element
      const emptyState = document.createElement('div');
      emptyState.id = 'search-empty-state';
      emptyState.className = 'hidden text-center py-8 px-4 text-secondary';
      emptyState.innerHTML = '<p class="text-sm">No matching lessons</p>';
      nav?.appendChild(emptyState);

      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase().trim();

        // Remove previous highlights
        document.querySelectorAll('.search-highlight').forEach((el) => {
          const parent = el.parentNode;
          if (parent) {
            parent.replaceChild(document.createTextNode(el.textContent || ''), el);
            parent.normalize();
          }
        });

        if (!query) {
          // Show all items and sections
          navItems.forEach((item) => item.classList.remove('hidden'));
          sections.forEach((section) => section.classList.remove('hidden'));
          emptyState.classList.add('hidden');
          return;
        }

        let hasVisibleItems = false;

        // Filter and highlight nav items
        navItems.forEach((item) => {
          const textContent = item.textContent?.toLowerCase() || '';

          if (textContent.includes(query)) {
            item.classList.remove('hidden');
            hasVisibleItems = true;

            // Highlight matching text
            highlightText(item as HTMLElement, query);
          } else {
            item.classList.add('hidden');
          }
        });

        // Hide empty sections
        sections.forEach((section) => {
          const visibleItems = section.querySelectorAll('[data-nav-item]:not(.hidden)');
          if (visibleItems.length === 0) {
            section.classList.add('hidden');
          } else {
            section.classList.remove('hidden');
          }
        });

        // Show/hide empty state
        if (hasVisibleItems) {
          emptyState.classList.add('hidden');
        } else {
          emptyState.classList.remove('hidden');
        }
      });
    }

    function highlightText(element: HTMLElement, query: string) {
      const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);

      const nodesToReplace: Array<{ node: Node; text: string }> = [];

      let node;
      while ((node = walker.nextNode())) {
        const text = node.textContent || '';
        const lowerText = text.toLowerCase();

        if (lowerText.includes(query)) {
          nodesToReplace.push({ node, text });
        }
      }

      nodesToReplace.forEach(({ node, text }) => {
        const lowerText = text.toLowerCase();
        const index = lowerText.indexOf(query);

        if (index === -1) return;

        const beforeText = text.substring(0, index);
        const matchText = text.substring(index, index + query.length);
        const afterText = text.substring(index + query.length);

        const fragment = document.createDocumentFragment();

        if (beforeText) fragment.appendChild(document.createTextNode(beforeText));

        const mark = document.createElement('mark');
        mark.className = 'search-highlight';
        mark.textContent = matchText;
        fragment.appendChild(mark);

        if (afterText) fragment.appendChild(document.createTextNode(afterText));

        node.parentNode?.replaceChild(fragment, node);
      });
    }

    // ============================================================================
    // Dark Mode Toggle
    // ============================================================================

    function initDarkMode() {
      const toggleButton = document.getElementById('theme-toggle');

      if (!toggleButton) return;

      toggleButton.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark');

        if (isDark) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      });
    }

    // ============================================================================
    // Resizable Sidebar
    // ============================================================================

    function initResizable() {
      const container = document.getElementById('left-sidebar-container') as HTMLElement;
      const handle = container?.querySelector('.resize-handle') as HTMLElement;

      // The actual sidebar element in the grid is the parent <aside>
      const sidebar = document.getElementById('left-sidebar') as HTMLElement;

      // Get the grid container
      const gridContainer = document.querySelector('.app-body') as HTMLElement;

      if (!container || !handle || !sidebar || !gridContainer) return;

      // Restore width from localStorage
      const storedWidth = localStorage.getItem(STORAGE_KEYS.width);
      if (storedWidth) {
        const width = parseInt(storedWidth, 10);
        const minWidth = parseInt(
          getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-min'),
          10,
        );
        const maxWidth = parseInt(
          getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-max'),
          10,
        );

        if (width >= minWidth && width <= maxWidth) {
          sidebar.style.width = `${width}px`;
          updateGridColumns(gridContainer, width);
        }
      }

      let isResizing = false;
      let startX = 0;
      let startWidth = 0;

      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const delta = e.clientX - startX;
        const newWidth = startWidth + delta;
        const minWidth = parseInt(
          getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-min'),
          10,
        );
        const maxWidth = parseInt(
          getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-max'),
          10,
        );

        if (newWidth >= minWidth && newWidth <= maxWidth) {
          sidebar.style.width = `${newWidth}px`;
          updateGridColumns(gridContainer, newWidth);
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';

          // Save to localStorage
          localStorage.setItem(STORAGE_KEYS.width, sidebar.offsetWidth.toString());
        }
      });
    }

    function updateGridColumns(gridContainer: HTMLElement, sidebarWidth: number) {
      // Get the ToC width from CSS variable
      const tocWidth = getComputedStyle(document.documentElement)
        .getPropertyValue('--toc-width')
        .trim();

      // Update grid template columns: sidebar | content (1fr) | toc
      gridContainer.style.gridTemplateColumns = `${sidebarWidth}px 1fr ${tocWidth}`;
    }

    // ============================================================================
    // Initialize All Features
    // ============================================================================

    initCollapsibleSections();
    initKeyboardNavigation();
    initSearch();
    initResizable();
    initDarkMode();
  }); // End DOMContentLoaded
</script>

<style>
  .sidebar-container {
    position: relative;
    display: flex;
    flex-direction: row;
    height: 100%;
  }

  .sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
  }

  /* Navigation Section */
  .nav-section {
    margin-bottom: 0.75rem;
  }

  /* Section Header */
  .nav-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.625rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color var(--transition-fast);
  }

  .nav-section-header:hover {
    background-color: var(--color-bg-tertiary);
  }

  /* Expanded section header has accent background */
  .nav-section.expanded .nav-section-header {
    background-color: var(--color-accent-bg);
  }

  /* +/× Icon */
  .nav-section-icon {
    font-size: 1.25rem;
    font-weight: 300;
    line-height: 1;
    color: var(--color-text-secondary);
  }

  /* Hide default content, show via ::before */
  .nav-section-icon {
    font-family: system-ui, sans-serif;
  }

  /* Collapsed shows + */
  .nav-section:not(.expanded) .nav-section-icon::before {
    content: '+';
  }

  /* Expanded shows × */
  .nav-section.expanded .nav-section-icon::before {
    content: '×';
  }

  /* Vertical bar for expanded sections */
  .nav-section-items {
    padding-top: 0.25rem;
    padding-left: 0.75rem;
    border-left: 2px solid var(--color-border);
    margin-left: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  /* Remove focus ring, use background tint instead */
  .nav-item:focus-visible {
    outline: none;
    background-color: var(--color-bg-tertiary);
  }

  /* Resize Handle */
  .resize-handle {
    width: 4px;
    cursor: col-resize;
    background: transparent;
    transition: background-color var(--transition-fast);
    flex-shrink: 0;
  }

  .resize-handle:hover {
    background-color: var(--color-accent);
  }

  /* Search Highlighting */
  .search-highlight {
    background-color: var(--color-accent-bg);
    color: var(--color-accent);
    font-weight: 600;
    padding: 0 0.125rem;
    border-radius: 0.125rem;
  }
</style>
